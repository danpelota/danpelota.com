<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>danpelota.com</title>
<link href="assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="rss.xml">
<link rel="canonical" href="https://danpelota.com/">
<!--[if lt IE 9]><script src="assets/js/html5.js"></script><![endif]--><link rel="prefetch" href="posts/geocoder-showdown-part-1/" type="text/html">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://danpelota.com/">

                <span id="blog-title">danpelota.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="#">home</a>
                </li>
<li>
<a href="archive.html">archives</a>
                </li>
<li>
<a href="http://github.com/danpelota">github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            

    
<div class="postindex">
    <article class="h-entry post-text"><header><h1 class="p-name entry-title"><a href="posts/geocoder-showdown-part-1/" class="u-url">Geocoder Showdown Part 1: Setup and Installation</a></h1>
        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                Dan Ball
            </span></p>
            <p class="dateline"><a href="posts/geocoder-showdown-part-1/" rel="bookmark"><time class="published dt-published" datetime="2016-09-19T00:00:00-04:00" title="2016-09-19 00:00">2016-09-19 00:00</time></a></p>
                <p class="commentline">
        
    <a href="posts/geocoder-showdown-part-1/#disqus_thread" data-disqus-identifier="cache/posts/geocoder-showdown-part-1.html">Comments</a>


        </p>
</div>
    </header><div class="e-content entry-content">
    <div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li>
<a class="reference internal" href="posts/geocoder-showdown-part-1/#installing-the-geocoders" id="id2">Installing the Geocoders</a><ul>
<li><a class="reference internal" href="posts/geocoder-showdown-part-1/#installing-postgresql-9-5-and-postgis-2-2" id="id3">Installing PostgreSQL 9.5 and PostGIS 2.2</a></li>
<li><a class="reference internal" href="posts/geocoder-showdown-part-1/#configuring-the-postgis-tiger-geocoder" id="id4">Configuring the PostGIS Tiger Geocoder</a></li>
<li><a class="reference internal" href="posts/geocoder-showdown-part-1/#the-geocommons-geocoder" id="id5">The Geocommons Geocoder</a></li>
<li><a class="reference internal" href="posts/geocoder-showdown-part-1/#installing-nominatim" id="id6">Installing Nominatim</a></li>
</ul>
</li>
</ul>
</div>
<p>Back in 2011, I <a class="reference external" href="http://gis.stackexchange.com/questions/7271/geocode-quality-nominatim-vs-postgis-geocoder-vs-geocoderus-2-0)">asked a question</a> on gis.stackexchange.com regarding the
accuracy of range-based geocoders that can be installed and run locally. Since
then, I've leveraged several solutions for the bulk geocoding of millions of
addresses, including the <a class="reference external" href="http://postgis.net/docs/Geocode.html">PostGIS geocoder</a>, the ruby-based <a class="reference external" href="https://github.com/geocommons/geocoder/">Geocommons
Geocoder</a>,  and <a class="reference external" href="https://smartystreets.com/">SmartyStreets</a> (which doesn't run locally but has no trouble
geocoding millions of addresses per hour). I haven't come across a
thorough comparison of the setup, usage, and performance of these
geocoders in the meantime, so I figured I'd evaluate them here.</p>
<p>In Part 1 I'll cover the installation and configuration of the PostGIS Tiger
geocoder, the Nominatim geocoder, and the Geocommons Geocoder. While there are
web services that expose each through APIs, I wanted to document the setup and
installation of each for offline processing.</p>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-2">Part 2</a> I'll download, prep, and geocode a reference dataset to use as a
benchmark: the Florida extract of the <a class="reference external" href="http://openaddresses.io">openaddresses.io</a> database.</p>
<p>In Part 3, we'll take a look at the accuracy of each geocoder against our
reference data set.</p>
<div class="section" id="installing-the-geocoders">
<h2><a class="toc-backref" href="posts/geocoder-showdown-part-1/#id2">Installing the Geocoders</a></h2>
<p>I'll install and evaluate the geocoders on an <tt class="docutils literal">m4.xlarge</tt> AWS EC2 instance
with 16GB of memory and a 50GB SSD, running the Ubuntu 16.04 LTS AMI
(<tt class="docutils literal"><span class="pre">ami-746aba14</span></tt>).</p>
<div class="section" id="installing-postgresql-9-5-and-postgis-2-2">
<h3><a class="toc-backref" href="posts/geocoder-showdown-part-1/#id3">Installing PostgreSQL 9.5 and PostGIS 2.2</a></h3>
<p>First we'll set the following PostgreSQL environment variables for convenience:</p>
<pre class="literal-block">
export PGDATABASE=geocoder
export PGUSER=postgres
</pre>
<p>Next, add the PostgreSQL apt repo and key:</p>
<pre class="literal-block">
sudo add-apt-repository \
    "deb http://apt.postgresql.org/pub/repos/apt/ xenial-pgdg main"
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | \
    sudo apt-key add -
sudo apt-get update
</pre>
<p>Install PostgreSQL 9.5 and PostGIS 2.2:</p>
<pre class="literal-block">
sudo apt-get install -y postgresql-9.5 postgresql-9.5-postgis-2.2 \
    postgresql-server-dev-9.5
export PATH='/usr/lib/postgresql/9.5/bin/':$PATH
</pre>
<p>The PostgreSQL APT repository doesn't package <tt class="docutils literal">shp2pgsql</tt> anymore, so install
it from the Ubuntu postgis repository:</p>
<pre class="literal-block">
sudo apt-get install postgis
</pre>
<p>You'll want to edit the PostgreSQL config file for optimum performance while
bulk-loading data (<tt class="docutils literal">/etc/postgresql/9.5/main/postgresql.conf</tt> on Ubuntu) .
Here's how I tuned my PostgreSQL cluster running on an instance with 16GB of
RAM:</p>
<pre class="literal-block">
shared_buffers = 4GB
work_mem = 50MB
maintenance_work_mem = 4GB
synchronous_commit = off``
checkpoint_timeout = 10min
checkpoint_completion_target = 0.9
effective_cache_size = 12GB
</pre>
<p>I've also set:</p>
<pre class="literal-block">
fsync = off
full_page_writes = off
</pre>
<p>Be sure to turn these on after the data has been loaded, or you'll risk not
only data <em>loss</em> in the event of a crash, but data <em>corruption</em>.</p>
<p>Also, before connecting to our database, you'll need to edit the <tt class="docutils literal">pg_hba.conf</tt>
file to <tt class="docutils literal">trust</tt> local connections.</p>
</div>
<div class="section" id="configuring-the-postgis-tiger-geocoder">
<h3><a class="toc-backref" href="posts/geocoder-showdown-part-1/#id4">Configuring the PostGIS Tiger Geocoder</a></h3>
<p>Create our PostGIS-enabled database and install the geocoder:</p>
<pre class="literal-block">
createdb
psql -c "CREATE EXTENSION postgis;"
psql -c "CREATE EXTENSION fuzzystrmatch;"
psql -c "CREATE EXTENSION address_standardizer;"
psql -c "CREATE EXTENSION postgis_tiger_geocoder;"
</pre>
<p>Now we'll generate and run the scripts that download and process the FL TIGER
data, as well as the national state and county lookup tables needed by the geocoder.</p>
<pre class="literal-block">
sudo apt-get install unzip

cd ~
sudo mkdir /gisdata
sudo chown ubuntu /gisdata
psql -t -c "SELECT Loader_Generate_Script(ARRAY['FL'], 'sh');" -o import-fl.sh --no-align
sh import-fl.sh
# Go for a long walk
psql -t -c "SELECT loader_generate_nation_script('sh');" -o import-nation.sh --no-align
sh import-nation.sh
</pre>
<p>Just for good measure:</p>
<pre class="literal-block">
psql -c "SELECT install_missing_indexes();"
psql -c "vacuum analyze verbose tiger.addr;"
psql -c "vacuum analyze verbose tiger.edges;"
psql -c "vacuum analyze verbose tiger.faces;"
psql -c "vacuum analyze verbose tiger.featnames;"
psql -c "vacuum analyze verbose tiger.place;"
psql -c "vacuum analyze verbose tiger.cousub;"
psql -c "vacuum analyze verbose tiger.county;"
psql -c "vacuum analyze verbose tiger.state;"
</pre>
<p>Check that the geocoder and all necessary data was installed correctly:</p>
<pre class="literal-block">
psql -c "SELECT st_x(geomout), st_y(geomout) FROM geocode('400 S Monroe St, Tallahassee, FL 32399', 1);"

       st_x        |       st_y
-------------------+------------------
 -84.2807360244119 | 30.4381207774995
</pre>
<p>With that, our PostGIS TIGER geocoder is installed and ready to go.</p>
</div>
<div class="section" id="the-geocommons-geocoder">
<h3><a class="toc-backref" href="posts/geocoder-showdown-part-1/#id5">The Geocommons Geocoder</a></h3>
<p>Install some dependencies:</p>
<pre class="literal-block">
apt-get install -y ruby-dev sqlite3 libsqlite3-dev flex
gem install text sqlite3 fastercsv
</pre>
<p>Grab the latest version of the geocommons geocoder and install it:</p>
<pre class="literal-block">
cd ~
apt-get install git flex ruby-dev
git clone git://github.com/geocommons/geocoder.git
cd geocoder
make
make install
gem install Geocoder-US-2.0.4.gem
gem install text
</pre>
<p>We can use the 2015 Tiger data we downloaded previously:</p>
<pre class="literal-block">
mkdir data
mkdir database
cd data
cp /gisdata/ftp2.census.gov/geo/tiger/TIGER2015/ADDR/*.zip ./
cp /gisdata/ftp2.census.gov/geo/tiger/TIGER2015/FEATNAMES/*.zip ./
cp /gisdata/ftp2.census.gov/geo/tiger/TIGER2015/EDGES/*.zip ./
</pre>
<p>Create the geocoder database. Note that this must be executed from within the
<tt class="docutils literal">build</tt> directory since it has a relative path reference to
<tt class="docutils literal"><span class="pre">../src/shp2sqlite/shp2sqlite</span></tt>:</p>
<pre class="literal-block">
cd ../build
./tiger_import ../database/geocoder.db ../data
sh build_indexes ../database/geocoder.db
cd ..
bin/rebuild_metaphones database/geocoder.db
sudo sh build/rebuild_cluster database/geocoder.db
</pre>
<p>To test the geocommons geocoder, fire up an irb session and geocode a test
address:</p>
<pre class="literal-block">
irb(main):001:0&gt; require 'geocoder/us'
=&gt; true

irb(main):002:0&gt; db = Geocoder::US::Database.new('database/geocoder.db')
=&gt; #&lt;Geocoder::US::Database:0x00000001cc1248 @db=#&lt;SQLite3::Database:0x00000001cc1158&gt;, @st={}, @dbtype=1, @debug=false, @threadsafe=false&gt;

irb(main):003:0&gt; p db.geocode("400 S Monroe St, Tallahassee, FL 32399")
[{:street=&gt;"S Monroe St",
  :zip=&gt;"32301",
  :score=&gt;0.805,
  :prenum=&gt;"",
  :number=&gt;"400",
  :precision=&gt;:range,
  :lon=&gt;-84.280632,
  :lat=&gt;30.438122}]
</pre>
</div>
<div class="section" id="installing-nominatim">
<h3><a class="toc-backref" href="posts/geocoder-showdown-part-1/#id6">Installing Nominatim</a></h3>
<p>Install the Nominatim dependencies (some of these were installed in previous
steps, but are included here for completeness):</p>
<pre class="literal-block">
sudo apt-get install -y build-essential cmake g++ libboost-dev \
    libboost-system-dev libboost-filesystem-dev libexpat1-dev zlib1g-dev \
    libxml2-dev libbz2-dev libpq-dev libgeos-dev libgeos++-dev \
    libproj-dev postgresql-server-dev-9.5 postgresql-9.5-postgis-2.2 \
    postgresql-contrib-9.5 apache2 php php-pgsql libapache2-mod-php \
    php-pear php-db git
</pre>
<p>Separate linux user accounts for nominatim:</p>
<pre class="literal-block">
sudo useradd -d /srv/nominatim -s /bin/bash -m nominatim

export USERNAME=nominatim
export USERHOME=/srv/nominatim
sudo chmod a+wx $USERHOME

createuser -s $USERNAME
createuser -s www-data
</pre>
<p>Install Nominatim:</p>
<pre class="literal-block">
cd $USERHOME
git clone --recursive git://github.com/twain47/Nominatim.git
cd Nominatim
</pre>
<p>Building must happen within the <tt class="docutils literal">build</tt> directory:</p>
<pre class="literal-block">
mkdir build
cd build
cmake $USERHOME/Nominatim
make
</pre>
<p>Setup the apache webserver:</p>
<pre class="literal-block">
sudo tee /etc/apache2/conf-available/nominatim.conf &lt;&lt; EOFAPACHECONF
&lt;Directory "$USERHOME/Nominatim/build/website"&gt;
  Options FollowSymLinks MultiViews
  AddType text/html   .php
  Require all granted
&lt;/Directory&gt;

Alias /nominatim $USERHOME/Nominatim/build/website
EOFAPACHECONF
</pre>
<p>Enable the configuration and restart apache:</p>
<pre class="literal-block">
sudo a2enconf nominatim
sudo systemctl restart apache2
</pre>
<p>Update the nominatim php settings (<tt class="docutils literal">settings/settings.php</tt>) to reflect our
version of PostgreSQL, PostGIS, and our local website URL:</p>
<pre class="literal-block">
// Software versions
@define('CONST_Database_DSN', 'pgsql://postgres@localhost/nominatim');

// Website settings
@define('CONST_Website_BaseURL', '/nominatim/');
</pre>
<p>Now that Nominatim is installed and configured, we need to download and process
the Florida extract of the OpenStreetMap data:</p>
<pre class="literal-block">
wget -P /gisdata/ http://download.geofabrik.de/north-america/us/florida-latest.osm.pbf
./utils/setup.php --osm-file /gisdata/florida-latest.osm.pbf --all
</pre>
<p>At this point, you should be able to point your browser to
<tt class="docutils literal"><span class="pre">http://localhost/nominatim/status.php</span></tt> and get a page with the text "OK".</p>
<p>Nominatim can use TIGER address data to supplement the OSM house number data.
Luckily, we already have the TIGER EDGE data downloaded. We'll need to convert
the data to SQL to use it:</p>
<pre class="literal-block">
sudo apt-get install python-gdal
sudo apt-get install gdal-bin

./utils/imports.php --parse-tiger /gisdata/ftp2.census.gov/geo/tiger/TIGER2015/EDGES/
</pre>
<p>Then we'll load it:</p>
<pre class="literal-block">
./utils/setup.php --import-tiger-data
</pre>
<p>Enable the use of Tiger data in the settings/local.php file:</p>
<pre class="literal-block">
@define('CONST_Use_US_Tiger_Data', true);
./utils/setup.php --create-functions --enable-diff-updates --create-partition-functions
</pre>
<p>Again, let's geocode a test address to confirm everything is configured correctly:</p>
<pre class="literal-block">
curl "http://127.0.0.1/nominatim/search.php?q=400%20S%20Monroe%20St%2C%20Tallahassee%2C%20FL%2032399&amp;format=json"

[{"place_id":"1828601",
  "licence":"Data © OpenStreetMap contributors, ODbL 1.0. http:\/\/www.openstreetmap.org\/copyright",
  "osm_type":"tiger",
  "osm_id":"1828601",
  "boundingbox":["30.437948","30.438048","-84.280774","-84.280674"],
  "lat":"30.437998",
  "lon":"-84.280724",
  "display_name":"400, South Monroe Street, Tallahassee, Leon County, Florida, 32301, United States of America",
  "class":"place",
  "type":"house",
  "importance":0.511}]
</pre>
<p>At this point, all three geocoders are functional and loaded with 2015 range
data. In <a class="reference external" href="/posts/geocoder-showdown-part-2">Part 2</a> we'll load and geocode some benchmark data.</p>
</div>
</div>
</div>
    </div>
    </article>
</div>



        
       <script>var disqus_shortname="danpelota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:dan@danpelota.com">Dan Ball</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84560292-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
