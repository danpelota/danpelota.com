<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Geocoder Showdown Part 2: Geocoding Benchmark Data | danpelota.com</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://danpelota.com/posts/geocoder-showdown-part-2/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dan Ball">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="danpelota.com">
<meta property="og:title" content="Geocoder Showdown Part 2: Geocoding Benchmark Data">
<meta property="og:url" content="https://danpelota.com/posts/geocoder-showdown-part-2/">
<meta property="og:description" content="Contents

OpenAddresses Data
Geocoding: PostGIS Tiger Geocoder


In Part 1 I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll d">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-23T19:53:44-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://danpelota.com/">

                <span id="blog-title">danpelota.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../index.html">home</a>
                </li>
<li>
<a href="../../archive.html">archives</a>
                </li>
<li>
<a href="http://github.com/danpelota">github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Geocoder Showdown Part 2: Geocoding Benchmark Data</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Dan Ball
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-09-23T19:53:44-04:00" itemprop="datePublished" title="2016-09-23 19:53">2016-09-23 19:53</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/geocoder-showdown-part-2.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#openaddresses-data" id="id1">OpenAddresses Data</a></li>
<li><a class="reference internal" href="#geocoding-postgis-tiger-geocoder" id="id2">Geocoding: PostGIS Tiger Geocoder</a></li>
</ul>
</div>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-1">Part 1</a> I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll download and geocode
some reference data for evaluation.</p>
<div class="section" id="openaddresses-data">
<h2><a class="toc-backref" href="#id1">OpenAddresses Data</a></h2>
<p>OpenAddresses.io is an effort to aggregate and standardize a global collection
of address data. We'll be using the Florida extract of the OpenAddresses.io
data. Download it to get started:</p>
<pre class="literal-block">
wget http://s3.amazonaws.com/data.openaddresses.io/openaddr-collected-us_south.zip
unzip openaddr-collected-us_south.zip
cd us/fl
</pre>
<p>Create our table to hold the data:</p>
<pre class="literal-block">
psql &lt;&lt; EOF
CREATE TABLE addresses (
    lon float,
    lat float,
    house_number text,
    street text,
    unit text,
    city text,
    district text,
    region text,
    postcode text,
    id text,
    hash text);
EOF
</pre>
<p>Now copy in all CSV files. There is some overlapping coverage, but we'll deal
with that later:</p>
<pre class="literal-block">
for FILE in *.csv
do
    echo "Loading $FILE"
    psql -c "\copy addresses FROM $FILE CSV HEADER"
done
</pre>
<p>Pop open <tt class="docutils literal">psql</tt> and let's take a look!</p>
<pre class="literal-block">
SELECT count(*) FROM addresses;
  count
----------
 20558789
</pre>
<p>20 million addresses, ripe for geocoding! However, the OpenAddresses data is
based on aggregated data from public sources, which often incomplete. Let's
check the coverage of the address fields:</p>
<pre class="literal-block">
SELECT
   count(*) AS total,
   count(house_number) AS h_number,
   count(street) AS street,
   count(city) AS city,
   count(postcode) AS postcode,
   count(COALESCE(city, postcode)) AS city_or_post,
   count(house_number || street || city || postcode) AS all
FROM
   addresses;

-[ RECORD 1 ]+---------
total        | 20558789
h_number     | 18432928
street       | 20538609
city         | 17411392
postcode     | 10488002
city_or_post | 20223850
all          |  7610472
</pre>
<p>It looks like only half of all addresses have a zip code, 17.4 million
have a city, and 7.6 million have all address components. Instead of
dropping those without all address components, we'll classify each address
based on the availability of the address components to see how the
geocoders stand up to missing data:</p>
<pre class="literal-block">
ALTER TABLE addresses ADD COLUMN components TEXT;

-- Consider "unincorporated" to be a missing city component
UPDATE addresses SET city = NULL WHERE city = 'Unincorporated';

UPDATE ADDRESSES
SET components =
    CASE
        -- We won't even try to geocode these
        WHEN house_number || street IS NULL THEN 'bad'
        WHEN city || postcode IS NOT NULL THEN 'all'
        WHEN city IS NOT NULL then 'city only'
        WHEN postcode IS NOT NULL THEN 'postcode only'
        ELSE 'street only'
    END;

SELECT components, COUNT(*) FROM addresses GROUP BY 1;

  components   |  count
---------------+---------
 bad           | 2131815
 all           | 7019191
 postcode only | 3390495
 street only   |  327029
 city only     | 7690259
</pre>
<p>Let's create a stratified random sample of these addresses:</p>
<blockquote>
<ul class="simple">
<li>35,000 (70%) with all address components</li>
<li>7,500 (15%) with postcode only</li>
<li>7,500 (15%) with city only</li>
</ul>
</blockquote>
<pre class="literal-block">
SELECT setseed(0.5);
CREATE TABLE sampled_addy AS
(
    SELECT *
    FROM addresses
    WHERE components = 'all'
    ORDER BY random()
    LIMIT 35000
)
UNION ALL
(
    SELECT *
    FROM addresses
    WHERE components = 'postcode only'
    ORDER BY random()
    LIMIT 7500
)
UNION ALL
(
    SELECT *
    FROM addresses
    WHERE components = 'city only'
    ORDER BY random()
    LIMIT 7500
);

ALTER TABLE sampled_addy ADD COLUMN addy_id SERIAL PRIMARY KEY;
</pre>
<p>Now that we have a more manageable test set, let's do a little additional
hygiene:</p>
<pre class="literal-block">
UPDATE sampled_addy
SET
    street = upper(street),
    unit = upper(unit),
    -- I noticed some city names have embedded hyphens/underscores
    city = upper(regexp_replace(city, '_|-', ' ', 'g')),
    -- Should only be Florida
    region = 'FL';
</pre>
<p>Let's create a geospatial point column representing the coordinates:</p>
<pre class="literal-block">
ALTER TABLE sampled_addy ADD COLUMN geom GEOMETRY('POINT', 4326);

UPDATE sampled_addy
SET geom = ST_SetSrid(ST_MakePoint(lon, lat), 4326);

CREATE INDEX ON sampled_addy USING gist(geom);
</pre>
</div>
<div class="section" id="geocoding-postgis-tiger-geocoder">
<h2><a class="toc-backref" href="#id2">Geocoding: PostGIS Tiger Geocoder</a></h2>
<pre class="literal-block">
CREATE TABLE tiger_geocoded (
    addy_id integer,
    lat float,
    lon float,
    geom geometry('POINT', 4326),
    precision float,
    method text);

INSERT INTO tiger_geocoded
SELECT
    addy_id,
    ST_Y((g.geo).geomout)::numeric,
    ST_X((g.geo).geomout)::numeric,
    ST_Transform((g.geo).geomout, 4326),
    (g.geo).rating,
    'postgis'
FROM (
    SELECT
        addy_id,
        geocode((house_number || ' ' ||
                 street || ' ' ||
                 city || ' ' ||
                 region || ' ' || postcode),
                1) as geo
    FROM new_samp
    ) g;
</pre>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="danpelota",
            disqus_url="https://danpelota.com/posts/geocoder-showdown-part-2/",
        disqus_title="Geocoder Showdown Part 2: Geocoding Benchmark Data",
        disqus_identifier="cache/posts/geocoder-showdown-part-2.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="danpelota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:dan@danpelota.com">Dan Ball</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "YYYY-MM-DD HH:mm");
    </script><!-- end fancy dates --><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84560292-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
