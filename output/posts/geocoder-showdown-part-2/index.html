<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Geocoder Showdown Part 2: Geocoding Benchmark Data | danpelota.com</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://danpelota.com/posts/geocoder-showdown-part-2/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dan Ball">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="danpelota.com">
<meta property="og:title" content="Geocoder Showdown Part 2: Geocoding Benchmark Data">
<meta property="og:url" content="https://danpelota.com/posts/geocoder-showdown-part-2/">
<meta property="og:description" content="Contents

OpenAddresses Data
Geocoding: PostGIS Tiger Geocoder


In Part 1 I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll d">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-23T19:53:44-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://danpelota.com/">

                <span id="blog-title">danpelota.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../index.html">home</a>
                </li>
<li>
<a href="../../archive.html">archives</a>
                </li>
<li>
<a href="http://github.com/danpelota">github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Geocoder Showdown Part 2: Geocoding Benchmark Data</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Dan Ball
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-09-23T19:53:44-04:00" itemprop="datePublished" title="09/23/2016">09/23/2016</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/geocoder-showdown-part-2.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#openaddresses-data" id="id1">OpenAddresses Data</a></li>
<li><a class="reference internal" href="#geocoding-postgis-tiger-geocoder" id="id2">Geocoding: PostGIS Tiger Geocoder</a></li>
</ul>
</div>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-1">Part 1</a> I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll download and geocode
some reference data for evaluation.</p>
<div class="section" id="openaddresses-data">
<h2><a class="toc-backref" href="#id1">OpenAddresses Data</a></h2>
<p>OpenAddresses.io is an effort to aggregate and standardize a global collection
of address data. We'll be using the Florida extract of the OpenAddresses.io
data. Download it to get started.</p>
<pre class="code bash"><a name="rest_code_8b22e2891556416aadcd5c7dfd71e50a-1"></a>wget http://s3.amazonaws.com/data.openaddresses.io/openaddr-collected-us_south.zip
<a name="rest_code_8b22e2891556416aadcd5c7dfd71e50a-2"></a>unzip openaddr-collected-us_south.zip
<a name="rest_code_8b22e2891556416aadcd5c7dfd71e50a-3"></a><span class="nb">cd</span> us/fl
</pre>
<p>Create our table to hold the data:</p>
<pre class="code bash"><a name="rest_code_ad20a244f4004dba820df7e3729d0970-1"></a>psql <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-2"></a><span class="s">CREATE TABLE addresses (</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-3"></a><span class="s">    lon float,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-4"></a><span class="s">    lat float,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-5"></a><span class="s">    house_number text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-6"></a><span class="s">    street text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-7"></a><span class="s">    unit text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-8"></a><span class="s">    city text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-9"></a><span class="s">    district text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-10"></a><span class="s">    region text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-11"></a><span class="s">    postcode text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-12"></a><span class="s">    id text,</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-13"></a><span class="s">    hash text);</span>
<a name="rest_code_ad20a244f4004dba820df7e3729d0970-14"></a><span class="s">EOF</span>
</pre>
<p>Now copy in all CSV files. There is some overlapping coverage in these files,
but we'll deal with that later.</p>
<pre class="code bash"><a name="rest_code_95cd9f4362cb4afc8a6fc34ed2feaae8-1"></a><span class="k">for</span> FILE in *.csv
<a name="rest_code_95cd9f4362cb4afc8a6fc34ed2feaae8-2"></a><span class="k">do</span>
<a name="rest_code_95cd9f4362cb4afc8a6fc34ed2feaae8-3"></a>    <span class="nb">echo</span> <span class="s2">"Loading </span><span class="nv">$FILE</span><span class="s2">"</span>
<a name="rest_code_95cd9f4362cb4afc8a6fc34ed2feaae8-4"></a>    psql -c <span class="s2">"\copy addresses FROM </span><span class="nv">$FILE</span><span class="s2"> CSV HEADER"</span>
<a name="rest_code_95cd9f4362cb4afc8a6fc34ed2feaae8-5"></a><span class="k">done</span>
</pre>
<p>Pop open <tt class="docutils literal">psql</tt> and let's take a look!</p>
<pre class="code sql"><a name="rest_code_0823f740eae84eb58b289b72ef9a9b54-1"></a><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_0823f740eae84eb58b289b72ef9a9b54-2"></a>  <span class="k">count</span>
<a name="rest_code_0823f740eae84eb58b289b72ef9a9b54-3"></a><span class="c1">----------</span>
<a name="rest_code_0823f740eae84eb58b289b72ef9a9b54-4"></a> <span class="mi">20558789</span>
</pre>
<p>20 million addresses, ripe for geocoding! However, the OpenAddresses data is
based on aggregated data from public sources, which often incomplete. Let's
check the coverage of the address fields.</p>
<pre class="code sql"><a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-1"></a><span class="k">SELECT</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-2"></a>   <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-3"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">h_number</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-4"></a>   <span class="k">count</span><span class="p">(</span><span class="n">street</span><span class="p">)</span> <span class="k">AS</span> <span class="n">street</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-5"></a>   <span class="k">count</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">AS</span> <span class="n">city</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-6"></a>   <span class="k">count</span><span class="p">(</span><span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="n">postcode</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-7"></a>   <span class="k">count</span><span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">postcode</span><span class="p">))</span> <span class="k">AS</span> <span class="n">city_or_post</span><span class="p">,</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-8"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="o">||</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="k">all</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-9"></a><span class="k">FROM</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-10"></a>   <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-11"></a>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-12"></a><span class="o">-</span><span class="p">[</span> <span class="n">RECORD</span> <span class="mi">1</span> <span class="p">]</span><span class="o">+</span><span class="c1">---------</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-13"></a><span class="n">total</span>        <span class="o">|</span> <span class="mi">20558789</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-14"></a><span class="n">h_number</span>     <span class="o">|</span> <span class="mi">18432928</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-15"></a><span class="n">street</span>       <span class="o">|</span> <span class="mi">20538609</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-16"></a><span class="n">city</span>         <span class="o">|</span> <span class="mi">17411392</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-17"></a><span class="n">postcode</span>     <span class="o">|</span> <span class="mi">10488002</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-18"></a><span class="n">city_or_post</span> <span class="o">|</span> <span class="mi">20223850</span>
<a name="rest_code_ca6d2fa45efb4f0b8d52c502b97db960-19"></a><span class="k">all</span>          <span class="o">|</span>  <span class="mi">7610472</span>
</pre>
<p>It looks like only half (10 million) of all addresses have a zip code, 17.4
million have a city, and 7.6 million have all address components. Instead of
dropping those without all address components, we'll classify each address
based on the completeness of the components to see how the geocoders stand up
to missing data.</p>
<pre class="code sql"><a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">addresses</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">components</span> <span class="nb">TEXT</span><span class="p">;</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-2"></a>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-3"></a><span class="c1">-- Consider "unincorporated" to be a missing city component</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-4"></a><span class="k">UPDATE</span> <span class="n">addresses</span> <span class="k">SET</span> <span class="n">city</span> <span class="o">=</span> <span class="k">NULL</span> <span class="k">WHERE</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">'Unincorporated'</span><span class="p">;</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-5"></a>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-6"></a><span class="k">UPDATE</span> <span class="n">ADDRESSES</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-7"></a><span class="k">SET</span> <span class="n">components</span> <span class="o">=</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-8"></a>    <span class="k">CASE</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-9"></a>        <span class="c1">-- We won't even try to geocode these</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-10"></a>        <span class="k">WHEN</span> <span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'bad'</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-11"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'all'</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-12"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">then</span> <span class="s1">'city only'</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-13"></a>        <span class="k">WHEN</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'postcode only'</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-14"></a>        <span class="k">ELSE</span> <span class="s1">'street only'</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-15"></a>    <span class="k">END</span><span class="p">;</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-16"></a>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-17"></a><span class="k">SELECT</span> <span class="n">components</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-18"></a>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-19"></a>  <span class="n">components</span>   <span class="o">|</span>  <span class="k">count</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-20"></a><span class="c1">---------------+---------</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-21"></a> <span class="n">bad</span>           <span class="o">|</span> <span class="mi">2131815</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-22"></a> <span class="k">all</span>           <span class="o">|</span> <span class="mi">7019191</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-23"></a> <span class="n">postcode</span> <span class="k">only</span> <span class="o">|</span> <span class="mi">3390495</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-24"></a> <span class="n">street</span> <span class="k">only</span>   <span class="o">|</span>  <span class="mi">327029</span>
<a name="rest_code_418f3f86cfd04c71b0c24cb06d1edfda-25"></a> <span class="n">city</span> <span class="k">only</span>     <span class="o">|</span> <span class="mi">7690259</span>
</pre>
<p>Let's create a stratified random sample of these addresses:</p>
<blockquote>
<ul class="simple">
<li>35,000 (70%) with all address components</li>
<li>7,500 (15%) with postcode only</li>
<li>7,500 (15%) with city only</li>
</ul>
</blockquote>
<pre class="code sql"><a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-1"></a><span class="k">SELECT</span> <span class="n">setseed</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-2"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">AS</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-3"></a><span class="p">(</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-4"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-5"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-6"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'all'</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-7"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-8"></a>    <span class="k">LIMIT</span> <span class="mi">35000</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-9"></a><span class="p">)</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-10"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-11"></a><span class="p">(</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-12"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-13"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-14"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'postcode only'</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-15"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-16"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-17"></a><span class="p">)</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-18"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-19"></a><span class="p">(</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-20"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-21"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-22"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'city only'</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-23"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-24"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-25"></a><span class="p">);</span>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-26"></a>
<a name="rest_code_a640a6e3b06c44d4ae3c7a34465a9444-27"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">addy_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">;</span>
</pre>
<p>Now that we have a more manageable test set, let's do a little additional
hygiene:</p>
<pre class="code sql"><a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-1"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-2"></a><span class="k">SET</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-3"></a>    <span class="n">street</span> <span class="o">=</span> <span class="k">upper</span><span class="p">(</span><span class="n">street</span><span class="p">),</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-4"></a>    <span class="n">unit</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">unit</span><span class="p">),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-5"></a>    <span class="c1">-- I noticed some city names have embedded hyphens/underscores</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-6"></a>    <span class="n">city</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s1">'_|-'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">)),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-7"></a>    <span class="c1">-- Should only be Florida</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-8"></a>    <span class="n">region</span> <span class="o">=</span> <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_a14b4900f3ce406f8cafe36ec219cfc3-9"></a>    <span class="n">postcode</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s1">''</span><span class="p">);</span>
</pre>
<p>Let's create a geospatial point column representing the coordinates.</p>
<pre class="code sql"><a name="rest_code_fe835763017d45ff9c0d492e417e99b9-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">geom</span> <span class="n">GEOMETRY</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_fe835763017d45ff9c0d492e417e99b9-2"></a>
<a name="rest_code_fe835763017d45ff9c0d492e417e99b9-3"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_fe835763017d45ff9c0d492e417e99b9-4"></a><span class="k">SET</span> <span class="n">geom</span> <span class="o">=</span> <span class="n">ST_SetSrid</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_fe835763017d45ff9c0d492e417e99b9-5"></a>
<a name="rest_code_fe835763017d45ff9c0d492e417e99b9-6"></a><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">sampled_addy</span> <span class="k">USING</span> <span class="n">gist</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre>
</div>
<div class="section" id="geocoding-postgis-tiger-geocoder">
<h2><a class="toc-backref" href="#id2">Geocoding: PostGIS Tiger Geocoder</a></h2>
<p>We'll create a table to hold the results from each geocoder. First, the Tiger geocoder.</p>
<pre class="code sql"><a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-1"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">tiger_geocoded</span> <span class="p">(</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-2"></a>    <span class="n">addy_id</span> <span class="nb">integer</span><span class="p">,</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-3"></a>    <span class="n">lat</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-4"></a>    <span class="n">lon</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-5"></a>    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-6"></a>    <span class="k">precision</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_4e94c47d90a0471399c4fb9c92fab845-7"></a>    <span class="k">method</span> <span class="nb">text</span><span class="p">);</span>
</pre>
<p>We have a few options on the granularity of the address components we submit.
One option is to concatenate all address components into a single freeform
string and let the geocoder's address parser handle it. However, since we
already have some address components broken out, we can also try specifying the
city, state, and zip code components individually. The street number and name
components still need to be parsed since the unit numbers are often embedded in
the <tt class="docutils literal">street</tt> field and predirections are not broken out. We'll try both.</p>
<p>First, using the freeform addresses. The <tt class="docutils literal">geocode</tt> function will accept a
freeform address string, parse the address into the geocoder's <tt class="docutils literal">norm_addy</tt>
type, and return the normalized address, the geocoded geometry, and a rating
representing the estimated quality of the geocode.</p>
<pre class="code sql"><a name="rest_code_8f18195b10954e59bffe88b75b319212-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tiger_geocoded</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-2"></a><span class="k">SELECT</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-8"></a>    <span class="s1">'postgis-freeform'</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-11"></a>        <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-12"></a>        <span class="n">geocode</span><span class="p">((</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-13"></a>                 <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-14"></a>                 <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-15"></a>                 <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">),</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-16"></a>                <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-17"></a>    <span class="k">FROM</span> <span class="n">sampled_addy</span>
<a name="rest_code_8f18195b10954e59bffe88b75b319212-18"></a>    <span class="p">)</span> <span class="k">g</span><span class="p">;</span>
</pre>
<p>Let's try one more time, manually setting the city, state, and zipcode where
available. We'll still need the geocoder to parse the address so we can extract
the street number, predirection, street name, postdirection, and unit number.</p>
<pre class="code sql"><a name="rest_code_0059a081ff0b437c87c2fe5757a50022-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tiger_geocoded</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-2"></a><span class="k">SELECT</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-8"></a>    <span class="s1">'postgis-parsed'</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-11"></a>        <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-12"></a>        <span class="n">geocode</span><span class="p">(</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-13"></a>            <span class="p">(</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-14"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">address</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-15"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">predirabbrev</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-16"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streetname</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-17"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streettypeabbrev</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-18"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">postdirabbrev</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-19"></a>                <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">internal</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-20"></a>                <span class="n">city</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-21"></a>                <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-22"></a>                <span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-23"></a>                <span class="k">true</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-24"></a>            <span class="p">)::</span><span class="n">norm_addy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-25"></a>    <span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-26"></a>            <span class="k">SELECT</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-27"></a>                <span class="o">*</span><span class="p">,</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-28"></a>                <span class="n">normalize_address</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-29"></a>                     <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-30"></a>                     <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-31"></a>                     <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">as</span> <span class="n">norm</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-32"></a>             <span class="k">FROM</span> <span class="n">sampled_addy</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-33"></a>             <span class="k">LIMIT</span> <span class="mi">10</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-34"></a>        <span class="p">)</span> <span class="n">n</span>
<a name="rest_code_0059a081ff0b437c87c2fe5757a50022-35"></a><span class="p">)</span> <span class="k">g</span><span class="p">;</span>
</pre>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="danpelota",
            disqus_url="https://danpelota.com/posts/geocoder-showdown-part-2/",
        disqus_title="Geocoder Showdown Part 2: Geocoding Benchmark Data",
        disqus_identifier="cache/posts/geocoder-showdown-part-2.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="danpelota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents Â© 2016         <a href="mailto:dan@danpelota.com">Dan Ball</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "MM/DD/YYYY");
    </script><!-- end fancy dates --><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84560292-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
