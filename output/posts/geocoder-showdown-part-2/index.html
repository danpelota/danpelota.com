<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Geocoder Showdown Part 2: Geocoding Benchmark Data | danpelota.com</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/ipython.min.css" rel="stylesheet" type="text/css">
<link href="../../assets/css/nikola_ipython.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://danpelota.com/posts/geocoder-showdown-part-2/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dan Ball">
<link rel="prev" href="../geocoder-showdown-part-1/" title="Geocoder Showdown Part 1: Setup and Installation" type="text/html">
<link rel="next" href="../geocoder-showdown-part-3/" title="Geocoder Showdown Part 3" type="text/html">
<meta property="og:site_name" content="danpelota.com">
<meta property="og:title" content="Geocoder Showdown Part 2: Geocoding Benchmark Data">
<meta property="og:url" content="https://danpelota.com/posts/geocoder-showdown-part-2/">
<meta property="og:description" content="Contents

OpenAddresses Data
Geocoding: PostGIS Tiger Geocoder
Geocoding: The Geocommons Geocoder::US
Geocoding: Nominatim


In Part 1 I covered the installation and configuration of the PostGIS, Open">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-23T19:53:44-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-inverse navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://danpelota.com/">

                <span id="blog-title">danpelota.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../index.html">home</a>
                </li>
<li>
<a href="../../archive.html">archives</a>
                </li>
<li>
<a href="http://github.com/danpelota">github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Geocoder Showdown Part 2: Geocoding Benchmark Data</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Dan Ball
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-09-23T19:53:44-04:00" itemprop="datePublished" title="09/23/2016">09/23/2016</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/geocoder-showdown-part-2.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#openaddresses-data" id="id1">OpenAddresses Data</a></li>
<li><a class="reference internal" href="#geocoding-postgis-tiger-geocoder" id="id2">Geocoding: PostGIS Tiger Geocoder</a></li>
<li><a class="reference internal" href="#geocoding-the-geocommons-geocoder-us" id="id3">Geocoding: The Geocommons Geocoder::US</a></li>
<li><a class="reference internal" href="#geocoding-nominatim" id="id4">Geocoding: Nominatim</a></li>
</ul>
</div>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-1">Part 1</a> I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll download and geocode
some reference data for evaluation. In <a class="reference external" href="/posts/geocoder-showdown-part-3">Part 3</a> I'll compare the results.</p>
<p>First, we'll download, load, and postprocess the OpenAddresses data we're using
as a reference. Then, we'll pull out a sample of 50,000 records and geocode
them with each of our geocoders.</p>
<div class="section" id="openaddresses-data">
<h2><a class="toc-backref" href="#id1">OpenAddresses Data</a></h2>
<p>OpenAddresses is an effort to aggregate and standardize a global collection
of address data. We'll be using the Florida extract of the OpenAddresses
data as our benchmark. Download it to get started.</p>
<pre class="code bash"><a name="rest_code_c8e460d982fe4fc4b94e97c9b7a22d8f-1"></a>wget http://s3.amazonaws.com/data.openaddresses.io/openaddr-collected-us_south.zip
<a name="rest_code_c8e460d982fe4fc4b94e97c9b7a22d8f-2"></a>unzip openaddr-collected-us_south.zip
<a name="rest_code_c8e460d982fe4fc4b94e97c9b7a22d8f-3"></a><span class="nb">cd</span> us/fl
</pre>
<p>Create our table to hold the data:</p>
<pre class="code bash"><a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-1"></a>psql <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-2"></a><span class="s">CREATE TABLE addresses (</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-3"></a><span class="s">    lon float,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-4"></a><span class="s">    lat float,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-5"></a><span class="s">    house_number text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-6"></a><span class="s">    street text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-7"></a><span class="s">    unit text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-8"></a><span class="s">    city text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-9"></a><span class="s">    district text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-10"></a><span class="s">    region text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-11"></a><span class="s">    postcode text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-12"></a><span class="s">    id text,</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-13"></a><span class="s">    hash text);</span>
<a name="rest_code_6cb2339878b14b0dbdf8d26f60130246-14"></a><span class="s">EOF</span>
</pre>
<p>Now load all the CSV files. There is some overlapping coverage in these files
but we'll deal with that later.</p>
<pre class="code bash"><a name="rest_code_c535d668931943328942ff75e05edad6-1"></a><span class="k">for</span> FILE in *.csv
<a name="rest_code_c535d668931943328942ff75e05edad6-2"></a><span class="k">do</span>
<a name="rest_code_c535d668931943328942ff75e05edad6-3"></a>    <span class="nb">echo</span> <span class="s2">"Loading </span><span class="nv">$FILE</span><span class="s2">"</span>
<a name="rest_code_c535d668931943328942ff75e05edad6-4"></a>    psql -c <span class="s2">"\copy addresses FROM </span><span class="nv">$FILE</span><span class="s2"> CSV HEADER"</span>
<a name="rest_code_c535d668931943328942ff75e05edad6-5"></a><span class="k">done</span>
</pre>
<p>Pop open <tt class="docutils literal">psql</tt> and let's take a look!</p>
<pre class="code sql"><a name="rest_code_88645b9bd78647ff8d60167d48727d23-1"></a><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_88645b9bd78647ff8d60167d48727d23-2"></a>  <span class="k">count</span>
<a name="rest_code_88645b9bd78647ff8d60167d48727d23-3"></a><span class="c1">----------</span>
<a name="rest_code_88645b9bd78647ff8d60167d48727d23-4"></a> <span class="mi">20558789</span>
</pre>
<p>20 million addresses, ripe for geocoding! Unfortunately, the OpenAddresses data
is based on aggregated data from public sources which is sometimes incomplete. Let's
check the coverage of the address fields.</p>
<pre class="code sql"><a name="rest_code_2859cb2bc773401ea23449552dae6ff4-1"></a><span class="k">SELECT</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-2"></a>   <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-3"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">h_number</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-4"></a>   <span class="k">count</span><span class="p">(</span><span class="n">street</span><span class="p">)</span> <span class="k">AS</span> <span class="n">street</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-5"></a>   <span class="k">count</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">AS</span> <span class="n">city</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-6"></a>   <span class="k">count</span><span class="p">(</span><span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="n">postcode</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-7"></a>   <span class="k">count</span><span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">postcode</span><span class="p">))</span> <span class="k">AS</span> <span class="n">city_or_post</span><span class="p">,</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-8"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="o">||</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="k">all</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-9"></a><span class="k">FROM</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-10"></a>   <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-11"></a>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-12"></a><span class="o">-</span><span class="p">[</span> <span class="n">RECORD</span> <span class="mi">1</span> <span class="p">]</span><span class="o">+</span><span class="c1">---------</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-13"></a><span class="n">total</span>        <span class="o">|</span> <span class="mi">20558789</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-14"></a><span class="n">h_number</span>     <span class="o">|</span> <span class="mi">18432928</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-15"></a><span class="n">street</span>       <span class="o">|</span> <span class="mi">20538609</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-16"></a><span class="n">city</span>         <span class="o">|</span> <span class="mi">17411392</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-17"></a><span class="n">postcode</span>     <span class="o">|</span> <span class="mi">10488002</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-18"></a><span class="n">city_or_post</span> <span class="o">|</span> <span class="mi">20223850</span>
<a name="rest_code_2859cb2bc773401ea23449552dae6ff4-19"></a><span class="k">all</span>          <span class="o">|</span>  <span class="mi">7610472</span>
</pre>
<p>It looks like only half (10 million) of all addresses have a zip code, 17.4
million have a city, and 7.6 million have all address components. Instead of
dropping those without all address components, we'll classify each address
based on the completeness of the components to see how the geocoders stand up
to missing data.</p>
<pre class="code sql"><a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">addresses</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">components</span> <span class="nb">TEXT</span><span class="p">;</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-2"></a>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-3"></a><span class="c1">-- Consider "unincorporated" to be a missing city component</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-4"></a><span class="k">UPDATE</span> <span class="n">addresses</span> <span class="k">SET</span> <span class="n">city</span> <span class="o">=</span> <span class="k">NULL</span> <span class="k">WHERE</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">'Unincorporated'</span><span class="p">;</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-5"></a>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-6"></a><span class="k">UPDATE</span> <span class="n">addresses</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-7"></a><span class="k">SET</span> <span class="n">components</span> <span class="o">=</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-8"></a>    <span class="k">CASE</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-9"></a>        <span class="c1">-- We won't even try to geocode these</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-10"></a>        <span class="k">WHEN</span> <span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'bad'</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-11"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'all'</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-12"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">then</span> <span class="s1">'city only'</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-13"></a>        <span class="k">WHEN</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'postcode only'</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-14"></a>        <span class="k">ELSE</span> <span class="s1">'street only'</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-15"></a>    <span class="k">END</span><span class="p">;</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-16"></a>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-17"></a><span class="k">SELECT</span> <span class="n">components</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-18"></a>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-19"></a>  <span class="n">components</span>   <span class="o">|</span>  <span class="k">count</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-20"></a><span class="c1">---------------+---------</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-21"></a> <span class="n">bad</span>           <span class="o">|</span> <span class="mi">2131815</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-22"></a> <span class="k">all</span>           <span class="o">|</span> <span class="mi">7019191</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-23"></a> <span class="n">postcode</span> <span class="k">only</span> <span class="o">|</span> <span class="mi">3390495</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-24"></a> <span class="n">street</span> <span class="k">only</span>   <span class="o">|</span>  <span class="mi">327029</span>
<a name="rest_code_0ebc717b838c4c6db8eacf7372148bbd-25"></a> <span class="n">city</span> <span class="k">only</span>     <span class="o">|</span> <span class="mi">7690259</span>
</pre>
<p>Let's create a stratified random sample of these addresses:</p>
<blockquote>
<ul class="simple">
<li>35,000 (70%) with all address components</li>
<li>7,500 (15%) with street + postcode only</li>
<li>7,500 (15%) with street + city only</li>
</ul>
</blockquote>
<pre class="code sql"><a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-1"></a><span class="k">SELECT</span> <span class="n">setseed</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-2"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">AS</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-3"></a><span class="p">(</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-4"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-5"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-6"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'all'</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-7"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-8"></a>    <span class="k">LIMIT</span> <span class="mi">35000</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-9"></a><span class="p">)</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-10"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-11"></a><span class="p">(</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-12"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-13"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-14"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'postcode only'</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-15"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-16"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-17"></a><span class="p">)</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-18"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-19"></a><span class="p">(</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-20"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-21"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-22"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'city only'</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-23"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-24"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-25"></a><span class="p">);</span>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-26"></a>
<a name="rest_code_c668cc85a9204b169a7ef8527acfe37a-27"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">addy_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">;</span>
</pre>
<p>Now that we have a more manageable test set, let's do a little additional
hygiene:</p>
<pre class="code sql"><a name="rest_code_d583bb7f4fa347cb982296c45b249e86-1"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-2"></a><span class="k">SET</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-3"></a>    <span class="n">street</span> <span class="o">=</span> <span class="k">upper</span><span class="p">(</span><span class="n">street</span><span class="p">),</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-4"></a>    <span class="n">unit</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">unit</span><span class="p">),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-5"></a>    <span class="c1">-- I noticed some city names have embedded hyphens/underscores</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-6"></a>    <span class="n">city</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s1">'_|-'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">)),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-7"></a>    <span class="c1">-- Should only be Florida</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-8"></a>    <span class="n">region</span> <span class="o">=</span> <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_d583bb7f4fa347cb982296c45b249e86-9"></a>    <span class="n">postcode</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s1">''</span><span class="p">);</span>
</pre>
<p>Let's create a geospatial point column representing the coordinates.</p>
<pre class="code sql"><a name="rest_code_aade370b597c43f29d692f2ab37351ac-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">geom</span> <span class="n">GEOMETRY</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_aade370b597c43f29d692f2ab37351ac-2"></a>
<a name="rest_code_aade370b597c43f29d692f2ab37351ac-3"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_aade370b597c43f29d692f2ab37351ac-4"></a><span class="k">SET</span> <span class="n">geom</span> <span class="o">=</span> <span class="n">ST_SetSrid</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_aade370b597c43f29d692f2ab37351ac-5"></a>
<a name="rest_code_aade370b597c43f29d692f2ab37351ac-6"></a><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">sampled_addy</span> <span class="k">USING</span> <span class="n">gist</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre>
</div>
<div class="section" id="geocoding-postgis-tiger-geocoder">
<h2><a class="toc-backref" href="#id2">Geocoding: PostGIS Tiger Geocoder</a></h2>
<p>We'll create a table to hold the results from each geocoder. First, the Tiger geocoder.</p>
<pre class="code sql"><a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-1"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">geocoded</span> <span class="p">(</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-2"></a>    <span class="n">addy_id</span> <span class="nb">integer</span><span class="p">,</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-3"></a>    <span class="n">lat</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-4"></a>    <span class="n">lon</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-5"></a>    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-6"></a>    <span class="k">precision</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-7"></a>    <span class="k">method</span> <span class="nb">text</span><span class="p">,</span>
<a name="rest_code_9f201b8636794c368b93f3ee985d0c9e-8"></a>    <span class="k">UNIQUE</span><span class="p">(</span><span class="n">addy_id</span><span class="p">,</span> <span class="k">method</span><span class="p">));</span>
</pre>
<p>We have a few options on the granularity of the address components we submit.
One option is to concatenate all address components into a single freeform
string and let the geocoder's address parser handle it. However, since we
already have some address components broken out, we can also try specifying the
city, state, and zip code components individually. The street number and name
components still need to be parsed since the unit numbers are often embedded in
the <tt class="docutils literal">street</tt> field and predirections are not broken out. We'll try both.</p>
<p>First we'll use the freeform addresses. The <tt class="docutils literal">geocode</tt> function will accept a
freeform address string, parse the address into the geocoder's <tt class="docutils literal">norm_addy</tt>
type, and return the normalized address, the geocoded geometry, and a rating
representing the estimated quality of the geocode.</p>
<p><a class="reference external" href="../../listings/geocode/geocode-freeform.sql.html">geocode/geocode-freeform.sql</a>  <a class="reference external" href="../../listings/geocode/geocode-freeform.sql">(Source)</a></p>
<pre class="code sql"><a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">geocoded</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-2"></a><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">addy_id</span><span class="p">)</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-8"></a>    <span class="s1">'postgis-freeform'</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-11"></a>        <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-12"></a>        <span class="n">geocode</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span> <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-13"></a>    <span class="k">FROM</span> <span class="n">sampled_addy</span> <span class="n">a</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-14"></a>        <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">geocoded</span> <span class="k">c</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="k">method</span> <span class="o">=</span> <span class="s1">'postgis-freeform'</span> <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-15"></a>    <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span> <span class="k">IS</span> <span class="k">NULL</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-16"></a>    <span class="p">)</span> <span class="k">g</span>
<a name="rest_code_6b9ad684a5b84bffb94cd82d72dbceab-17"></a><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">addy_id</span><span class="p">,</span> <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">;</span>
</pre>
<p>Let's try one more time, manually setting the city, state, and zipcode where
available. We'll still need the geocoder to parse the address so we can extract
the street number, predirection, street name, postdirection, and unit number.</p>
<p><a class="reference external" href="../../listings/geocode/geocode-parsed.sql.html">geocode/geocode-parsed.sql</a>  <a class="reference external" href="../../listings/geocode/geocode-parsed.sql">(Source)</a></p>
<pre class="code sql"><a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tiger_geocoded</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-2"></a><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">addy_id</span><span class="p">)</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-8"></a>    <span class="s1">'postgis-parsed'</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-11"></a>        <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-12"></a>        <span class="n">geocode</span><span class="p">(</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-13"></a>        <span class="p">(</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-14"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">address</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-15"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">predirabbrev</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-16"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streetname</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-17"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streettypeabbrev</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-18"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">postdirabbrev</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-19"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">internal</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-20"></a>            <span class="n">city</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-21"></a>            <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-22"></a>            <span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-23"></a>            <span class="k">true</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-24"></a>        <span class="p">)::</span><span class="n">norm_addy</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-25"></a>    <span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-26"></a>        <span class="k">SELECT</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-27"></a>            <span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-28"></a>            <span class="n">normalize_address</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-29"></a>            <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-30"></a>            <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-31"></a>            <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">as</span> <span class="n">norm</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-32"></a>        <span class="k">FROM</span> <span class="n">sampled_addy</span> <span class="n">a</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-33"></a>            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">geocoded</span> <span class="k">c</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="k">method</span> <span class="o">=</span> <span class="s1">'postgis-parsed'</span> <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-34"></a>        <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span> <span class="k">IS</span> <span class="k">NULL</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-35"></a>    <span class="p">)</span> <span class="n">n</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-36"></a><span class="p">)</span> <span class="k">g</span>
<a name="rest_code_842a4d7f20ce447bb95a2c49a3267444-37"></a><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">addy_id</span><span class="p">,</span> <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">;</span>
</pre>
</div>
<div class="section" id="geocoding-the-geocommons-geocoder-us">
<h2><a class="toc-backref" href="#id3">Geocoding: The Geocommons Geocoder::US</a></h2>
<p>Here's a quick ruby script to geocode our benchmark data with the Geocommons
geocoder (note that I've made no effort to make this efficient):</p>
<p><a class="reference external" href="../../listings/geocode/geocode-geocommons.rb.html">geocode/geocode-geocommons.rb</a>  <a class="reference external" href="../../listings/geocode/geocode-geocommons.rb">(Source)</a></p>
<pre class="code ruby"><a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-1"></a><span class="nb">require</span> <span class="s1">'pg'</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-2"></a><span class="nb">require</span> <span class="s1">'geocoder/us'</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-3"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-4"></a><span class="c1"># Path to the SQLite3 database we created during setup</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-5"></a><span class="n">db</span> <span class="o">=</span> <span class="no">Geocoder</span><span class="o">::</span><span class="no">US</span><span class="o">::</span><span class="no">Database</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'/home/ubuntu/geocoder/database/geocoder.db'</span><span class="p">)</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-6"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-7"></a><span class="c1"># Connection to our PostgreSQL database housing the benchmark data</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-8"></a><span class="n">conn</span> <span class="o">=</span> <span class="no">PG</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-9"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-10"></a><span class="n">geocoded</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-11"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-12"></a><span class="n">sql</span> <span class="o">=</span> <span class="sx">%q(</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-13"></a><span class="sx">SELECT</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-14"></a><span class="sx">    a.addy_id,</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-15"></a><span class="sx">    house_number || ' ' ||</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-16"></a><span class="sx">      street || ', ' ||</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-17"></a><span class="sx">      city || ' ' ||</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-18"></a><span class="sx">      region || ' ' ||</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-19"></a><span class="sx">      postcode AS freeform</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-20"></a><span class="sx">  FROM sampled_addy a</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-21"></a><span class="sx">  -- Only those we haven't geocoded</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-22"></a><span class="sx">  LEFT JOIN geocoded c ON c.method = 'geocommons' AND c.addy_id = a.addy_id</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-23"></a><span class="sx">  WHERE c.addy_id IS NULL;</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-24"></a><span class="sx">)</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-25"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-26"></a><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-27"></a><span class="n">result</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-28"></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s1">'freeform'</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-29"></a>    <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="kp">nil</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-30"></a>        <span class="c1"># skip if we don't have a match</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-31"></a>        <span class="n">g</span><span class="o">[</span><span class="ss">:addy_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s1">'addy_id'</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-32"></a>        <span class="n">geocoded</span> <span class="o">&lt;&lt;</span> <span class="n">g</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-33"></a>    <span class="k">end</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-34"></a><span class="k">end</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-35"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-36"></a><span class="n">conn</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-37"></a>  <span class="s1">'insert'</span><span class="p">,</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-38"></a>  <span class="s2">"INSERT INTO geocoded (addy_id, lat, lon, precision, method) "</span><span class="p">\</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-39"></a>  <span class="s2">"VALUES ($1, $2, $3, $4, 'geocommons') "</span><span class="p">)</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-40"></a>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-41"></a><span class="n">geocoded</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">coded</span><span class="o">|</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-42"></a>    <span class="n">conn</span><span class="o">.</span><span class="n">exec_prepared</span><span class="p">(</span><span class="s1">'insert'</span><span class="p">,</span> <span class="o">[</span><span class="n">coded</span><span class="o">[</span><span class="ss">:addy_id</span><span class="o">]</span><span class="p">,</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-43"></a>                                  <span class="n">coded</span><span class="o">[</span><span class="ss">:lat</span><span class="o">]</span><span class="p">,</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-44"></a>                                  <span class="n">coded</span><span class="o">[</span><span class="ss">:lon</span><span class="o">]</span><span class="p">,</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-45"></a>                                  <span class="n">coded</span><span class="o">[</span><span class="ss">:score</span><span class="o">]]</span><span class="p">)</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-46"></a><span class="k">end</span>
<a name="rest_code_05fbc78086444ac1916c74f4d89c23c5-47"></a><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="section" id="geocoding-nominatim">
<h2><a class="toc-backref" href="#id4">Geocoding: Nominatim</a></h2>
<p>And finally, a python script to pull the freeform addresses from the database,
throw them at our Nominatim endpoint, and insert the results into our
<tt class="docutils literal">geocoded</tt> table:</p>
<p><a class="reference external" href="../../listings/geocode/geocode-nominatim.py.html">geocode/geocode-nominatim.py</a>  <a class="reference external" href="../../listings/geocode/geocode-nominatim.py">(Source)</a></p>
<pre class="code python"><a name="rest_code_7080e8789f15484c9440436ebbc8bdce-1"></a><span class="kn">import</span> <span class="nn">requests</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-2"></a><span class="kn">import</span> <span class="nn">psycopg2</span> <span class="kn">as</span> <span class="nn">pg</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-3"></a>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-4"></a><span class="n">con</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="s1">'geocoder'</span><span class="p">)</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-5"></a><span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-6"></a>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-7"></a><span class="c1"># The nominatime endpoint from our local installation</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-8"></a><span class="n">url</span> <span class="o">=</span> <span class="s1">'http://localhost/nominatim/search.php'</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-9"></a><span class="n">sql</span> <span class="o">=</span> <span class="s1">'''</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-10"></a><span class="s1">SELECT</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-11"></a><span class="s1">    a.addy_id,</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-12"></a><span class="s1">    house_number || ' ' || street || ', ' || city || ' ' || region || ' ' || postcode as freeform</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-13"></a><span class="s1">  FROM sampled_addy a</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-14"></a><span class="s1">  LEFT JOIN geocoded c ON c.method = 'nominatim' AND c.addy_id = a.addy_id</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-15"></a><span class="s1">  WHERE c.addy_id IS NULL;</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-16"></a><span class="s1">'''</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-17"></a>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-18"></a><span class="n">geocoded</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-19"></a>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-20"></a><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-21"></a><span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-22"></a>    <span class="c1"># Make a get request to our nominatime endpoint with our address</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-23"></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'q'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'format'</span><span class="p">:</span> <span class="s1">'json'</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-24"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-25"></a>        <span class="n">coded</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-26"></a>        <span class="n">coded</span><span class="p">[</span><span class="s1">'addy_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-27"></a>        <span class="n">geocoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coded</span><span class="p">)</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-28"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-29"></a>        <span class="k">pass</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-30"></a>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-31"></a><span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s1">'''</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-32"></a><span class="s1">    INSERT INTO geocoded(addy_id, lat, lon, method)</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-33"></a><span class="s1">    VALUES(</span><span class="si">%(addy_id)s</span><span class="s1">, </span><span class="si">%(lat)s</span><span class="s1">, </span><span class="si">%(lon)s</span><span class="s1">, 'nominatim')'''</span><span class="p">,</span> <span class="n">geocoded</span><span class="p">)</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-34"></a><span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="rest_code_7080e8789f15484c9440436ebbc8bdce-35"></a><span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-3">Part 3</a> we'll analyze the results.</p>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav><ul class="pager hidden-print">
<li class="previous">
                <a href="../geocoder-showdown-part-1/" rel="prev" title="Geocoder Showdown Part 1: Setup and Installation">Previous post</a>
            </li>
            <li class="next">
                <a href="../geocoder-showdown-part-3/" rel="next" title="Geocoder Showdown Part 3">Next post</a>
            </li>
        </ul></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="danpelota",
            disqus_url="https://danpelota.com/posts/geocoder-showdown-part-2/",
        disqus_title="Geocoder Showdown Part 2: Geocoding Benchmark Data",
        disqus_identifier="cache/posts/geocoder-showdown-part-2.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="danpelota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents  2016         <a href="mailto:dan@danpelota.com">Dan Ball</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "MM/DD/YYYY");
    </script><!-- end fancy dates --><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84560292-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
