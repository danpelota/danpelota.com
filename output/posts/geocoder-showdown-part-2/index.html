<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article# " lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Geocoder Showdown Part 2: Geocoding Benchmark Data | danpelota.com</title>
<link href="../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta content="#5670d4" name="theme-color">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../../rss.xml">
<link rel="canonical" href="https://danpelota.com/posts/geocoder-showdown-part-2/">
<!--[if lt IE 9]><script src="../../assets/js/html5.js"></script><![endif]--><meta name="author" content="Dan Ball">
<meta name="robots" content="noindex">
<meta property="og:site_name" content="danpelota.com">
<meta property="og:title" content="Geocoder Showdown Part 2: Geocoding Benchmark Data">
<meta property="og:url" content="https://danpelota.com/posts/geocoder-showdown-part-2/">
<meta property="og:description" content="Contents

OpenAddresses Data
Geocoding: PostGIS Tiger Geocoder
Geocoding: The Ruby Geocoder
Geocoding: Nominatim


In Part 1 I covered the installation and configuration of the PostGIS, Open
Addresses">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2016-09-23T19:53:44-04:00">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-default navbar-static-top"><div class="container">
<!-- This keeps the margins nice -->
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="https://danpelota.com/">

                <span id="blog-title">danpelota.com</span>
            </a>
        </div>
<!-- /.navbar-header -->
        <div class="collapse navbar-collapse" id="bs-navbar" aria-expanded="false">
            <ul class="nav navbar-nav">
<li>
<a href="../../index.html">home</a>
                </li>
<li>
<a href="../../archive.html">archives</a>
                </li>
<li>
<a href="http://github.com/danpelota">github</a>

                
            </li>
</ul>
<ul class="nav navbar-nav navbar-right">
<li>
    <a href="index.rst" id="sourcelink">Source</a>
    </li>

                
            </ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        <div class="row">
            
            
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">Geocoder Showdown Part 2: Geocoding Benchmark Data</a></h1>

        <div class="metadata">
            <p class="byline author vcard"><span class="byline-name fn">
                    Dan Ball
            </span></p>
            <p class="dateline"><a href="." rel="bookmark"><time class="published dt-published" datetime="2016-09-23T19:53:44-04:00" itemprop="datePublished" title="09/23/2016">09/23/2016</time></a></p>
                <p class="commentline">
        
    <a href="#disqus_thread" data-disqus-identifier="cache/posts/geocoder-showdown-part-2.html">Comments</a>


            
        </p>
<p class="sourceline"><a href="index.rst" id="sourcelink">Source</a></p>

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <div>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#openaddresses-data" id="id1">OpenAddresses Data</a></li>
<li><a class="reference internal" href="#geocoding-postgis-tiger-geocoder" id="id2">Geocoding: PostGIS Tiger Geocoder</a></li>
<li><a class="reference internal" href="#geocoding-the-ruby-geocoder" id="id3">Geocoding: The Ruby Geocoder</a></li>
<li><a class="reference internal" href="#geocoding-nominatim" id="id4">Geocoding: Nominatim</a></li>
</ul>
</div>
<p>In <a class="reference external" href="/posts/geocoder-showdown-part-1">Part 1</a> I covered the installation and configuration of the PostGIS, Open
Addresses, and Nominatim geocoders. In this article we'll download and geocode
some reference data for evaluation.</p>
<p>First, we'll download, load, and postprocess the OpenAddresses data we're using
as a reference. Then, we'll pull out a sample of 50,000 records and geocode
them with each of our geocoders.</p>
<p>The approach I've taken for each is not necessarily the most performant</p>
<div class="section" id="openaddresses-data">
<h2><a class="toc-backref" href="#id1">OpenAddresses Data</a></h2>
<p>OpenAddresses.io is an effort to aggregate and standardize a global collection
of address data. We'll be using the Florida extract of the OpenAddresses.io
data. Download it to get started.</p>
<pre class="code bash"><a name="rest_code_7b6fb2d70cc94c8fb227aa57815684d8-1"></a>wget http://s3.amazonaws.com/data.openaddresses.io/openaddr-collected-us_south.zip
<a name="rest_code_7b6fb2d70cc94c8fb227aa57815684d8-2"></a>unzip openaddr-collected-us_south.zip
<a name="rest_code_7b6fb2d70cc94c8fb227aa57815684d8-3"></a><span class="nb">cd</span> us/fl
</pre>
<p>Create our table to hold the data:</p>
<pre class="code bash"><a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-1"></a>psql <span class="s">&lt;&lt; EOF</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-2"></a><span class="s">CREATE TABLE addresses (</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-3"></a><span class="s">    lon float,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-4"></a><span class="s">    lat float,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-5"></a><span class="s">    house_number text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-6"></a><span class="s">    street text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-7"></a><span class="s">    unit text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-8"></a><span class="s">    city text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-9"></a><span class="s">    district text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-10"></a><span class="s">    region text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-11"></a><span class="s">    postcode text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-12"></a><span class="s">    id text,</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-13"></a><span class="s">    hash text);</span>
<a name="rest_code_87ec8d1ae80a485ebd6e709599b2ae4b-14"></a><span class="s">EOF</span>
</pre>
<p>Now copy in all CSV files. There is some overlapping coverage in these files,
but we'll deal with that later.</p>
<pre class="code bash"><a name="rest_code_5a426e11976e408ea3bd8873a4b02eea-1"></a><span class="k">for</span> FILE in *.csv
<a name="rest_code_5a426e11976e408ea3bd8873a4b02eea-2"></a><span class="k">do</span>
<a name="rest_code_5a426e11976e408ea3bd8873a4b02eea-3"></a>    <span class="nb">echo</span> <span class="s2">"Loading </span><span class="nv">$FILE</span><span class="s2">"</span>
<a name="rest_code_5a426e11976e408ea3bd8873a4b02eea-4"></a>    psql -c <span class="s2">"\copy addresses FROM </span><span class="nv">$FILE</span><span class="s2"> CSV HEADER"</span>
<a name="rest_code_5a426e11976e408ea3bd8873a4b02eea-5"></a><span class="k">done</span>
</pre>
<p>Pop open <tt class="docutils literal">psql</tt> and let's take a look!</p>
<pre class="code sql"><a name="rest_code_ea298ca8681740999da34026bb167db1-1"></a><span class="k">SELECT</span> <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_ea298ca8681740999da34026bb167db1-2"></a>  <span class="k">count</span>
<a name="rest_code_ea298ca8681740999da34026bb167db1-3"></a><span class="c1">----------</span>
<a name="rest_code_ea298ca8681740999da34026bb167db1-4"></a> <span class="mi">20558789</span>
</pre>
<p>20 million addresses, ripe for geocoding! However, the OpenAddresses data is
based on aggregated data from public sources, which often incomplete. Let's
check the coverage of the address fields.</p>
<pre class="code sql"><a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-1"></a><span class="k">SELECT</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-2"></a>   <span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">AS</span> <span class="n">total</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-3"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span><span class="p">)</span> <span class="k">AS</span> <span class="n">h_number</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-4"></a>   <span class="k">count</span><span class="p">(</span><span class="n">street</span><span class="p">)</span> <span class="k">AS</span> <span class="n">street</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-5"></a>   <span class="k">count</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">AS</span> <span class="n">city</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-6"></a>   <span class="k">count</span><span class="p">(</span><span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="n">postcode</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-7"></a>   <span class="k">count</span><span class="p">(</span><span class="n">COALESCE</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="n">postcode</span><span class="p">))</span> <span class="k">AS</span> <span class="n">city_or_post</span><span class="p">,</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-8"></a>   <span class="k">count</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="o">||</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">AS</span> <span class="k">all</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-9"></a><span class="k">FROM</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-10"></a>   <span class="n">addresses</span><span class="p">;</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-11"></a>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-12"></a><span class="o">-</span><span class="p">[</span> <span class="n">RECORD</span> <span class="mi">1</span> <span class="p">]</span><span class="o">+</span><span class="c1">---------</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-13"></a><span class="n">total</span>        <span class="o">|</span> <span class="mi">20558789</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-14"></a><span class="n">h_number</span>     <span class="o">|</span> <span class="mi">18432928</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-15"></a><span class="n">street</span>       <span class="o">|</span> <span class="mi">20538609</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-16"></a><span class="n">city</span>         <span class="o">|</span> <span class="mi">17411392</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-17"></a><span class="n">postcode</span>     <span class="o">|</span> <span class="mi">10488002</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-18"></a><span class="n">city_or_post</span> <span class="o">|</span> <span class="mi">20223850</span>
<a name="rest_code_97d18756e272408a9f171cf6f0c4de5a-19"></a><span class="k">all</span>          <span class="o">|</span>  <span class="mi">7610472</span>
</pre>
<p>It looks like only half (10 million) of all addresses have a zip code, 17.4
million have a city, and 7.6 million have all address components. Instead of
dropping those without all address components, we'll classify each address
based on the completeness of the components to see how the geocoders stand up
to missing data.</p>
<pre class="code sql"><a name="rest_code_caaab0e1560441739b274109b4ad859c-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">addresses</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">components</span> <span class="nb">TEXT</span><span class="p">;</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-2"></a>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-3"></a><span class="c1">-- Consider "unincorporated" to be a missing city component</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-4"></a><span class="k">UPDATE</span> <span class="n">addresses</span> <span class="k">SET</span> <span class="n">city</span> <span class="o">=</span> <span class="k">NULL</span> <span class="k">WHERE</span> <span class="n">city</span> <span class="o">=</span> <span class="s1">'Unincorporated'</span><span class="p">;</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-5"></a>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-6"></a><span class="k">UPDATE</span> <span class="n">addresses</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-7"></a><span class="k">SET</span> <span class="n">components</span> <span class="o">=</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-8"></a>    <span class="k">CASE</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-9"></a>        <span class="c1">-- We won't even try to geocode these</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-10"></a>        <span class="k">WHEN</span> <span class="n">house_number</span> <span class="o">||</span> <span class="n">street</span> <span class="k">IS</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'bad'</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-11"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="o">||</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'all'</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-12"></a>        <span class="k">WHEN</span> <span class="n">city</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">then</span> <span class="s1">'city only'</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-13"></a>        <span class="k">WHEN</span> <span class="n">postcode</span> <span class="k">IS</span> <span class="k">NOT</span> <span class="k">NULL</span> <span class="k">THEN</span> <span class="s1">'postcode only'</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-14"></a>        <span class="k">ELSE</span> <span class="s1">'street only'</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-15"></a>    <span class="k">END</span><span class="p">;</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-16"></a>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-17"></a><span class="k">SELECT</span> <span class="n">components</span><span class="p">,</span> <span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">addresses</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="mi">1</span><span class="p">;</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-18"></a>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-19"></a>  <span class="n">components</span>   <span class="o">|</span>  <span class="k">count</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-20"></a><span class="c1">---------------+---------</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-21"></a> <span class="n">bad</span>           <span class="o">|</span> <span class="mi">2131815</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-22"></a> <span class="k">all</span>           <span class="o">|</span> <span class="mi">7019191</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-23"></a> <span class="n">postcode</span> <span class="k">only</span> <span class="o">|</span> <span class="mi">3390495</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-24"></a> <span class="n">street</span> <span class="k">only</span>   <span class="o">|</span>  <span class="mi">327029</span>
<a name="rest_code_caaab0e1560441739b274109b4ad859c-25"></a> <span class="n">city</span> <span class="k">only</span>     <span class="o">|</span> <span class="mi">7690259</span>
</pre>
<p>Let's create a stratified random sample of these addresses:</p>
<blockquote>
<ul class="simple">
<li>35,000 (70%) with all address components</li>
<li>7,500 (15%) with postcode only</li>
<li>7,500 (15%) with city only</li>
</ul>
</blockquote>
<pre class="code sql"><a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-1"></a><span class="k">SELECT</span> <span class="n">setseed</span><span class="p">(</span><span class="mi">0</span><span class="p">.</span><span class="mi">5</span><span class="p">);</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-2"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">AS</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-3"></a><span class="p">(</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-4"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-5"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-6"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'all'</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-7"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-8"></a>    <span class="k">LIMIT</span> <span class="mi">35000</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-9"></a><span class="p">)</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-10"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-11"></a><span class="p">(</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-12"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-13"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-14"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'postcode only'</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-15"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-16"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-17"></a><span class="p">)</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-18"></a><span class="k">UNION</span> <span class="k">ALL</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-19"></a><span class="p">(</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-20"></a>    <span class="k">SELECT</span> <span class="o">*</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-21"></a>    <span class="k">FROM</span> <span class="n">addresses</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-22"></a>    <span class="k">WHERE</span> <span class="n">components</span> <span class="o">=</span> <span class="s1">'city only'</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-23"></a>    <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">random</span><span class="p">()</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-24"></a>    <span class="k">LIMIT</span> <span class="mi">7500</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-25"></a><span class="p">);</span>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-26"></a>
<a name="rest_code_c0c59c9408274e3197ef6baaac0e5986-27"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">addy_id</span> <span class="nb">SERIAL</span> <span class="k">PRIMARY</span> <span class="k">KEY</span><span class="p">;</span>
</pre>
<p>Now that we have a more manageable test set, let's do a little additional
hygiene:</p>
<pre class="code sql"><a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-1"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-2"></a><span class="k">SET</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-3"></a>    <span class="n">street</span> <span class="o">=</span> <span class="k">upper</span><span class="p">(</span><span class="n">street</span><span class="p">),</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-4"></a>    <span class="n">unit</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">unit</span><span class="p">),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-5"></a>    <span class="c1">-- I noticed some city names have embedded hyphens/underscores</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-6"></a>    <span class="n">city</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="k">upper</span><span class="p">(</span><span class="n">regexp_replace</span><span class="p">(</span><span class="n">city</span><span class="p">,</span> <span class="s1">'_|-'</span><span class="p">,</span> <span class="s1">' '</span><span class="p">,</span> <span class="s1">'g'</span><span class="p">)),</span> <span class="s1">''</span><span class="p">),</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-7"></a>    <span class="c1">-- Should only be Florida</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-8"></a>    <span class="n">region</span> <span class="o">=</span> <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_342ef707169c4f4fbbaa11cdf6ae70fc-9"></a>    <span class="n">postcode</span> <span class="o">=</span> <span class="n">COALESCE</span><span class="p">(</span><span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="s1">''</span><span class="p">);</span>
</pre>
<p>Let's create a geospatial point column representing the coordinates.</p>
<pre class="code sql"><a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-1"></a><span class="k">ALTER</span> <span class="k">TABLE</span> <span class="n">sampled_addy</span> <span class="k">ADD</span> <span class="k">COLUMN</span> <span class="n">geom</span> <span class="n">GEOMETRY</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-2"></a>
<a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-3"></a><span class="k">UPDATE</span> <span class="n">sampled_addy</span>
<a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-4"></a><span class="k">SET</span> <span class="n">geom</span> <span class="o">=</span> <span class="n">ST_SetSrid</span><span class="p">(</span><span class="n">ST_MakePoint</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span> <span class="n">lat</span><span class="p">),</span> <span class="mi">4326</span><span class="p">);</span>
<a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-5"></a>
<a name="rest_code_6f1edd2bb8164060b8b7a5160373afd1-6"></a><span class="k">CREATE</span> <span class="k">INDEX</span> <span class="k">ON</span> <span class="n">sampled_addy</span> <span class="k">USING</span> <span class="n">gist</span><span class="p">(</span><span class="n">geom</span><span class="p">);</span>
</pre>
</div>
<div class="section" id="geocoding-postgis-tiger-geocoder">
<h2><a class="toc-backref" href="#id2">Geocoding: PostGIS Tiger Geocoder</a></h2>
<p>We'll create a table to hold the results from each geocoder. First, the Tiger geocoder.</p>
<pre class="code sql"><a name="rest_code_54d944d0957243fdab7e36862fa5f85d-1"></a><span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">geocoded</span> <span class="p">(</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-2"></a>    <span class="n">addy_id</span> <span class="nb">integer</span><span class="p">,</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-3"></a>    <span class="n">lat</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-4"></a>    <span class="n">lon</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-5"></a>    <span class="n">geom</span> <span class="n">geometry</span><span class="p">(</span><span class="s1">'POINT'</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-6"></a>    <span class="k">precision</span> <span class="nb">float</span><span class="p">,</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-7"></a>    <span class="k">method</span> <span class="nb">text</span><span class="p">,</span>
<a name="rest_code_54d944d0957243fdab7e36862fa5f85d-8"></a>    <span class="k">UNIQUE</span><span class="p">(</span><span class="n">addy_id</span><span class="p">,</span> <span class="k">method</span><span class="p">));</span>
</pre>
<p>We have a few options on the granularity of the address components we submit.
One option is to concatenate all address components into a single freeform
string and let the geocoder's address parser handle it. However, since we
already have some address components broken out, we can also try specifying the
city, state, and zip code components individually. The street number and name
components still need to be parsed since the unit numbers are often embedded in
the <tt class="docutils literal">street</tt> field and predirections are not broken out. We'll try both.</p>
<p>First, using the freeform addresses. The <tt class="docutils literal">geocode</tt> function will accept a
freeform address string, parse the address into the geocoder's <tt class="docutils literal">norm_addy</tt>
type, and return the normalized address, the geocoded geometry, and a rating
representing the estimated quality of the geocode.</p>
<p><a class="reference external" href="../../listings/geocode/geocode-freeform.sql.html">geocode/geocode-freeform.sql</a>  <a class="reference external" href="../../listings/geocode/geocode-freeform.sql">(Source)</a></p>
<pre class="code sql"><a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">geocoded</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-2"></a><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">addy_id</span><span class="p">)</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-8"></a>    <span class="s1">'postgis-freeform'</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-11"></a>        <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-12"></a>        <span class="n">geocode</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span> <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-13"></a>    <span class="k">FROM</span> <span class="n">sampled_addy</span> <span class="n">a</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-14"></a>        <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">geocoded</span> <span class="k">c</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="k">method</span> <span class="o">=</span> <span class="s1">'postgis-freeform'</span> <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-15"></a>    <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span> <span class="k">IS</span> <span class="k">NULL</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-16"></a>    <span class="p">)</span> <span class="k">g</span>
<a name="rest_code_a841eba6b3ab40769bfca7dd97dfdaf4-17"></a><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">addy_id</span><span class="p">,</span> <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">;</span>
</pre>
<p>Let's try one more time, manually setting the city, state, and zipcode where
available. We'll still need the geocoder to parse the address so we can extract
the street number, predirection, street name, postdirection, and unit number.</p>
<p><a class="reference external" href="../../listings/geocode/geocode-parsed.sql.html">geocode/geocode-parsed.sql</a>  <a class="reference external" href="../../listings/geocode/geocode-parsed.sql">(Source)</a></p>
<pre class="code sql"><a name="rest_code_5f413045f6d4469ea6c2f57297072728-1"></a><span class="k">INSERT</span> <span class="k">INTO</span> <span class="n">tiger_geocoded</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-2"></a><span class="k">SELECT</span> <span class="k">DISTINCT</span> <span class="k">ON</span> <span class="p">(</span><span class="n">addy_id</span><span class="p">)</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-3"></a>    <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-4"></a>    <span class="n">ST_Y</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-5"></a>    <span class="n">ST_X</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">)::</span><span class="nb">numeric</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-6"></a>    <span class="n">ST_Transform</span><span class="p">((</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">geomout</span><span class="p">,</span> <span class="mi">4326</span><span class="p">),</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-7"></a>    <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-8"></a>    <span class="s1">'postgis-parsed'</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-9"></a><span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-10"></a>    <span class="k">SELECT</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-11"></a>        <span class="n">addy_id</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-12"></a>        <span class="n">geocode</span><span class="p">(</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-13"></a>        <span class="p">(</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-14"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">address</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-15"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">predirabbrev</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-16"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streetname</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-17"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">streettypeabbrev</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-18"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">postdirabbrev</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-19"></a>            <span class="p">(</span><span class="n">norm</span><span class="p">).</span><span class="n">internal</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-20"></a>            <span class="n">city</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-21"></a>            <span class="s1">'FL'</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-22"></a>            <span class="n">substr</span><span class="p">(</span><span class="n">postcode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-23"></a>            <span class="k">true</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-24"></a>        <span class="p">)::</span><span class="n">norm_addy</span><span class="p">)</span> <span class="k">as</span> <span class="n">geo</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-25"></a>    <span class="k">FROM</span> <span class="p">(</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-26"></a>        <span class="k">SELECT</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-27"></a>            <span class="n">a</span><span class="p">.</span><span class="o">*</span><span class="p">,</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-28"></a>            <span class="n">normalize_address</span><span class="p">(</span><span class="n">house_number</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-29"></a>            <span class="n">street</span> <span class="o">||</span> <span class="s1">', '</span> <span class="o">||</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-30"></a>            <span class="n">city</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-31"></a>            <span class="n">region</span> <span class="o">||</span> <span class="s1">' '</span> <span class="o">||</span> <span class="n">postcode</span><span class="p">)</span> <span class="k">as</span> <span class="n">norm</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-32"></a>        <span class="k">FROM</span> <span class="n">sampled_addy</span> <span class="n">a</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-33"></a>            <span class="k">LEFT</span> <span class="k">JOIN</span> <span class="n">geocoded</span> <span class="k">c</span> <span class="k">ON</span> <span class="k">c</span><span class="p">.</span><span class="k">method</span> <span class="o">=</span> <span class="s1">'postgis-parsed'</span> <span class="k">AND</span> <span class="n">a</span><span class="p">.</span><span class="n">addy_id</span> <span class="o">=</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-34"></a>        <span class="k">WHERE</span> <span class="k">c</span><span class="p">.</span><span class="n">addy_id</span> <span class="k">IS</span> <span class="k">NULL</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-35"></a>    <span class="p">)</span> <span class="n">n</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-36"></a><span class="p">)</span> <span class="k">g</span>
<a name="rest_code_5f413045f6d4469ea6c2f57297072728-37"></a><span class="k">ORDER</span> <span class="k">BY</span> <span class="n">addy_id</span><span class="p">,</span> <span class="p">(</span><span class="k">g</span><span class="p">.</span><span class="n">geo</span><span class="p">).</span><span class="n">rating</span><span class="p">;</span>
</pre>
</div>
<div class="section" id="geocoding-the-ruby-geocoder">
<h2><a class="toc-backref" href="#id3">Geocoding: The Ruby Geocoder</a></h2>
<p><a class="reference external" href="../../listings/geocode/geocode.rb.html">geocode/geocode.rb</a>  <a class="reference external" href="../../listings/geocode/geocode.rb">(Source)</a></p>
<pre class="code ruby"><a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-1"></a><span class="nb">require</span> <span class="s1">'pg'</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-2"></a><span class="nb">require</span> <span class="s1">'geocoder/us'</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-3"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-4"></a><span class="n">db</span> <span class="o">=</span> <span class="no">Geocoder</span><span class="o">::</span><span class="no">US</span><span class="o">::</span><span class="no">Database</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">'/home/ubuntu/geocoder/database/geocoder.db'</span><span class="p">)</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-5"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-6"></a><span class="n">conn</span> <span class="o">=</span> <span class="no">PG</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-7"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-8"></a><span class="n">geocoded</span> <span class="o">=</span> <span class="nb">Array</span><span class="o">.</span><span class="n">new</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-9"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-10"></a><span class="n">sql</span> <span class="o">=</span> <span class="sx">%q(</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-11"></a><span class="sx">SELECT</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-12"></a><span class="sx">    a.addy_id,</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-13"></a><span class="sx">    house_number || ' ' || street || ', ' || city || ' ' || region || ' ' || postcode as freeform</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-14"></a><span class="sx">  FROM sampled_addy a</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-15"></a><span class="sx">  LEFT JOIN geocoded c ON c.method = 'geocommons' AND c.addy_id = a.addy_id</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-16"></a><span class="sx">  WHERE c.addy_id IS NULL;</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-17"></a><span class="sx">)</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-18"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-19"></a><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">exec</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-20"></a><span class="n">result</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">row</span><span class="o">|</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-21"></a>    <span class="c1"># puts "%s" % row.values_at('freeform')[0]</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-22"></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">geocode</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s1">'freeform'</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-23"></a>    <span class="k">if</span> <span class="n">g</span> <span class="o">!=</span> <span class="kp">nil</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-24"></a>      <span class="n">g</span><span class="o">[</span><span class="ss">:addy_id</span><span class="o">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="s1">'addy_id'</span><span class="p">)</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-25"></a>      <span class="n">geocoded</span> <span class="o">&lt;&lt;</span> <span class="n">g</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-26"></a>    <span class="k">end</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-27"></a><span class="k">end</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-28"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-29"></a><span class="n">conn</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-30"></a>  <span class="s1">'insert'</span><span class="p">,</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-31"></a>  <span class="s2">"INSERT INTO geocoded (addy_id, lat, lon, precision, method) "</span><span class="p">\</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-32"></a>  <span class="s2">"VALUES ($1, $2, $3, $4, 'geocommons') "</span><span class="p">)</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-33"></a>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-34"></a><span class="n">geocoded</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">coded</span><span class="o">|</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-35"></a>  <span class="n">conn</span><span class="o">.</span><span class="n">exec_prepared</span><span class="p">(</span><span class="s1">'insert'</span><span class="p">,</span> <span class="o">[</span><span class="n">coded</span><span class="o">[</span><span class="ss">:addy_id</span><span class="o">]</span><span class="p">,</span> <span class="n">coded</span><span class="o">[</span><span class="ss">:lat</span><span class="o">]</span><span class="p">,</span> <span class="n">coded</span><span class="o">[</span><span class="ss">:lon</span><span class="o">]</span><span class="p">,</span> <span class="n">coded</span><span class="o">[</span><span class="ss">:score</span><span class="o">]]</span><span class="p">)</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-36"></a><span class="k">end</span>
<a name="rest_code_34fc0da0bcb84f14a1d1281dbbbfae1b-37"></a><span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
</div>
<div class="section" id="geocoding-nominatim">
<h2><a class="toc-backref" href="#id4">Geocoding: Nominatim</a></h2>
<p><a class="reference external" href="../../listings/geocode/geocode-nominatim.py.html">geocode/geocode-nominatim.py</a>  <a class="reference external" href="../../listings/geocode/geocode-nominatim.py">(Source)</a></p>
<pre class="code python"><a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-1"></a><span class="kn">import</span> <span class="nn">requests</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-2"></a><span class="kn">import</span> <span class="nn">psycopg2</span> <span class="kn">as</span> <span class="nn">pg</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-3"></a><span class="kn">from</span> <span class="nn">pprint</span> <span class="kn">import</span> <span class="n">pprint</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-4"></a>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-5"></a><span class="n">con</span> <span class="o">=</span> <span class="n">pg</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="s1">'geocoder'</span><span class="p">)</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-6"></a><span class="n">cur</span> <span class="o">=</span> <span class="n">con</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-7"></a>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-8"></a><span class="n">url</span> <span class="o">=</span> <span class="s1">'http://localhost/nominatim/search.php'</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-9"></a><span class="n">sql</span> <span class="o">=</span> <span class="s1">'''</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-10"></a><span class="s1">SELECT</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-11"></a><span class="s1">    a.addy_id,</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-12"></a><span class="s1">    house_number || ' ' || street || ', ' || city || ' ' || region || ' ' || postcode as freeform</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-13"></a><span class="s1">  FROM sampled_addy a</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-14"></a><span class="s1">  LEFT JOIN geocoded c ON c.method = 'nominatim' AND c.addy_id = a.addy_id</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-15"></a><span class="s1">  WHERE c.addy_id IS NULL;</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-16"></a><span class="s1">'''</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-17"></a>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-18"></a><span class="n">geocoded</span> <span class="o">=</span> <span class="p">[]</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-19"></a>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-20"></a><span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-21"></a><span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">cur</span><span class="p">:</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-22"></a>    <span class="n">g</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">'q'</span><span class="p">:</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s1">'format'</span><span class="p">:</span> <span class="s1">'json'</span><span class="p">})</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-23"></a>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-24"></a>        <span class="n">coded</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-25"></a>        <span class="n">coded</span><span class="p">[</span><span class="s1">'addy_id'</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-26"></a>        <span class="n">geocoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coded</span><span class="p">)</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-27"></a>    <span class="k">else</span><span class="p">:</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-28"></a>        <span class="k">pass</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-29"></a>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-30"></a><span class="n">cur</span><span class="o">.</span><span class="n">executemany</span><span class="p">(</span><span class="s2">"INSERT INTO geocoded(addy_id, lat, lon, method) VALUES(</span><span class="si">%(addy_id)s</span><span class="s2">, </span><span class="si">%(lat)s</span><span class="s2">, </span><span class="si">%(lon)s</span><span class="s2">, 'nominatim')"</span><span class="p">,</span> <span class="n">geocoded</span><span class="p">)</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-31"></a><span class="n">con</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<a name="rest_code_fcb2c7bf1b6246e0bac4617f7cd62811-32"></a><span class="n">con</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre>
<p># select geocode('146 Southwest 169 Avenue, Miramar Pembroke Pines FL');
# select geocode('146 Southwest 169 Avenue, Miramar Pembroke Pines FL', 1);</p>
<p>Get geocoding errors:</p>
<div class="system-message">
<p class="system-message-title">System Message: ERROR/3 (<tt class="docutils">&lt;string&gt;</tt>, line 244)</p>
<p>Error in "code-block" directive:
maximum 1 argument(s) allowed, 40 supplied.</p>
<pre class="literal-block">
.. code-block:: sql
    SELECT
        a.addy_id,
        a.house_number,
        a.street,
        a.city,
        a.region,
        a.postcode,
        a.components,
        a.lon as actual_lon,
        a.lat as actual_lat,
        a.geom as actual_geom,
        c.lon as coded_lon,
        c.lat as coded_lat,
        c.geom as coded_geom,
        c.precision,
        c.method,
        ST_DistanceSphere(a.geom, c.geom) as error
    FROM
        sampled_addy a
        JOIN geocoded c USING(addy_id);
</pre>
</div>
</div>
</div>
    </div>
    <aside class="postpromonav"><nav></nav></aside><section class="comments hidden-print"><h2>Comments</h2>
        
        
        <div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="danpelota",
            disqus_url="https://danpelota.com/posts/geocoder-showdown-part-2/",
        disqus_title="Geocoder Showdown Part 2: Geocoding Benchmark Data",
        disqus_identifier="cache/posts/geocoder-showdown-part-2.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = 'https://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="https://disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


        </section></article><script>var disqus_shortname="danpelota";(function(){var a=document.createElement("script");a.async=true;a.src="https://"+disqus_shortname+".disqus.com/count.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)}());</script>
</div>
        <!--End of body content-->

        <footer id="footer">
            Contents © 2016         <a href="mailto:dan@danpelota.com">Dan Ball</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
            
        </footer>
</div>
</div>


            <script src="../../assets/js/all-nocdn.js"></script><script>$('a.image-reference:not(.islink) img:not(.islink)').parent().colorbox({rel:"gal",maxWidth:"100%",maxHeight:"100%",scalePhotos:true});</script><!-- fancy dates --><script>
    moment.locale("en");
    fancydates(0, "MM/DD/YYYY");
    </script><!-- end fancy dates --><script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-84560292-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
